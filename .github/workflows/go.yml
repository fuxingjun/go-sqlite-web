name: Build and Release

on:
  push:
    tags:
      - 'v*' # å½“æ¨é€ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # -------------------------------
    # ğŸ”§ å‰ç«¯æ„å»ºï¼šVue + Vite (åœ¨ vue-go-sqlite ç›®å½•)
    # -------------------------------
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22' # æˆ– '20'ï¼Œæ¨èé•¿æœŸæ”¯æŒç‰ˆæœ¬
        cache: 'npm'       # ç¼“å­˜ npm ä¾èµ–
        cache-dependency-path: vue3-sqlite-web/package-lock.json
    - name: Install frontend dependencies
      run: |
        cd vue3-sqlite-web
        npm ci
    - name: Build frontend
      run: |
        cd vue3-sqlite-web
        npm run build
      
    # -------------------------------
    # ğŸ› ï¸ åç«¯æ„å»ºï¼šGo
    # -------------------------------
    - name: Set up Go 1.23
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'

    - name: Install dependencies (å¯é€‰)
      run: go mod download

    - name: Run build scripts
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        chmod +x build.sh
        ./build.sh $TAG_NAME
        
    - name: List release artifacts
      run: ls -la release/

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        # name è®¾ç½® Release åç§°ï¼Œé»˜è®¤ä¸º tag å ref:refs/tags/v0.0.2 ref_name:v0.0.2
        name: Release ${{ github.ref_name }}
        tag_name: ${{ github.ref_name }}
        files: release/*
        draft: false
        prerelease: ${{ contains(github.ref, '-pre') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}